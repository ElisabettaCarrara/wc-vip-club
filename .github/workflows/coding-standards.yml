name: Coding Standards (WPCS/CPCS + Auto-Fix)

on: [push, pull_request]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  standards:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}

      - name: Install Standards
        run: |
          composer init --no-interaction
          composer config allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
          composer require --dev wp-coding-standards/wpcs:^3.1 squizlabs/php_codesniffer:^3.10 --no-progress

      - name: CPCS Config
        run: |
          wget -O phpcs.xml https://raw.githubusercontent.com/ClassicPress/ClassicPress-Coding-Standards/main/phpcs.xml
          sed -i '/^\t<!-- start config -->/a <file>.</file>' phpcs.xml
          sed -i 's/MY_DOMAIN/wc-vip-club/g' phpcs.xml

      - name: PHPCS WPCS + CPCS
        run: |
          ./vendor/bin/phpcs . --extensions=php --ignore=vendor, node_modules --standard=WordPress,phpcs.xml --report-json=phpcs.json -n

      - name: Summary
        if: always()
        run: |
          npm i -g https://github.com/10up/phpcs-json-to-md/tarball/master
          phpcs-json-to-md --path ./phpcs.json --output ./phpcs.md
          cat ./phpcs.md >> $GITHUB_STEP_SUMMARY

      - name: PHPCBF Auto-Fix
        run: |
          ./vendor/bin/phpcbf . --extensions=php --ignore=vendor,node_modules --standard=WordPress,phpcs.xml

      - name: Commit Fixes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'fix: PHPCBF WPCS/CPCS [skip ci]'
          file_pattern: '*.php'
