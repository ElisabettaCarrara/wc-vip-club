name: WPCS Lint + Autofix

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lint-fix-lint:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    # Skip if triggered by our own auto-commit.
    if: "!contains(github.event.head_commit.message, 'PHPCBF auto-fixes')"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # PR: checkout PR branch. Push: checkout main.
          ref: ${{ github.head_ref || github.ref_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          coverage: none
          tools: composer

      # Cache Composer properly (cache dir, not vendor).
      - name: Cache Composer packages
        id: composer-cache
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      # Cache vendor for faster runs.
      - name: Cache vendor directory
        id: vendor-cache
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-vendor-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-vendor-

      - name: Install Composer dependencies
        if: steps.composer-cache.outputs.cache-hit != 'true' || steps.vendor-cache.outputs.cache-hit != 'true'
        run: |
          composer config allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
          composer install --no-interaction --prefer-dist --no-progress --optimize-autoloader

      - name: Install WPCS + WooCommerce sniffs (dev deps)
        run: |
          composer require --dev \
            "squizlabs/php_codesniffer:^3.10" \
            "wp-coding-standards/wpcs:^3.1" \
            "woocommerce/woocommerce-sniffs" \
            --no-interaction --no-update --no-progress || true

      # ------------------------------------
      # 1️⃣ Initial scan (informational)
      # ------------------------------------
      - name: PHPCS – initial scan
        run: |
          if [ ! -f "vendor/bin/phpcs" ]; then
            echo "❌ PHPCS not found, skipping lint"
            exit 0
          fi
          ./vendor/bin/phpcs ./ \
            --standard=.phpcs.xml.dist \
            --colors \
            --report=summary \
            --ignore=vendor,node_modules,build,assets,.github,tests,*.log \
            || true

      # ------------------------------------
      # 2️⃣ Autofix
      # ------------------------------------
      - name: PHPCBF – autofix
        run: |
          if [ ! -f "vendor/bin/phpcbf" ]; then
            echo "❌ PHPCBF not found, skipping fix"
            exit 0
          fi
          ./vendor/bin/phpcbf ./ \
            --standard=.phpcs.xml.dist \
            --no-patch \
            --ignore=vendor,node_modules,build,assets,.github,tests,*.log \
            || true

      # ------------------------------------
      # 3️⃣ Commit fixes (only if changes)
      # ------------------------------------
      - name: Commit auto-fixes
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: PHPCBF auto-fixes [skip ci]"
          branch: ${{ github.head_ref || github.ref_name }}
          file_pattern: |
            **/*.php
            !**/vendor/**
            !**/*.lock
            !**/composer.*
            !**/*.md
            !.github/**
          push_options: '--force-with-lease'
          skip_fetch: true
          skip_dirty_check: true

      # ------------------------------------
      # 4️⃣ Final scan (must pass on PRs)
      # ------------------------------------
      - name: PHPCS – final scan (fail if errors)
        if: github.event_name == 'pull_request'
        run: |
          if [ ! -f "vendor/bin/phpcs" ]; then
            echo "❌ PHPCS not found - cannot lint"
            exit 1
          fi
          ./vendor/bin/phpcs ./ \
            --standard=.phpcs.xml.dist \
            --colors \
            --report=summary \
            --ignore=vendor,node_modules,build,assets,.github,tests,*.log \
            || exit 1
