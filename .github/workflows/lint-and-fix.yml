name: "WPCS Lint + Autofix"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lint-fix-lint:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    if: "!contains(github.event.head_commit.message, 'PHPCBF auto-fixes')"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Cache Composer global
        uses: actions/cache@v4
        with:
          path: ~/.composer
          key: ${{ runner.os }}-composer-global-${{ hashFiles('**/composer.lock') }}

      # ---------------- PHPCS GLOBAL INSTALL ----------------
      - name: Install PHPCS globally
        run: |
          composer global config --no-plugins allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
          composer global config --no-plugins allow-plugins.composer/installers true
          composer global require \
            "squizlabs/php_codesniffer:^3.10" \
            "wp-coding-standards/wpcs:^3.1" \
            "woocommerce/woocommerce-sniffs" \
            --no-interaction --prefer-dist --no-progress

      # Add global bin to PATH
      - name: Setup PATH
        run: |
          echo "$HOME/.composer/vendor/bin" >> $GITHUB_PATH
          echo "$HOME/.config/composer/vendor/bin" >> $GITHUB_PATH

      # ------------------------------------
      # 1️⃣ Initial scan
      # ------------------------------------
      - name: "PHPCS - initial scan"
        run: |
          phpcs --version
          phpcs ./ \
            --standard=.phpcs.xml.dist \
            --colors --report=summary \
            --ignore=vendor,node_modules,build,assets,.github,tests,*.log \
            || true

      # ------------------------------------
      # 2️⃣ Autofix
      # ------------------------------------
      - name: "PHPCBF - autofix"
        run: |
          phpcbf ./ \
            --standard=.phpcs.xml.dist \
            --no-patch \
            --ignore=vendor,node_modules,build,assets,.github,tests,*.log \
            || true

      # ------------------------------------
      # 3️⃣ Commit (main only)
      # ------------------------------------
      - name: Commit auto-fixes
        if: github.ref == 'refs/heads/main'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: PHPCBF auto-fixes [skip ci]"
          file_pattern: "**/*.php"
          push_options: "--force"

      # ------------------------------------
      # 4️⃣ Final lint (ALWAYS runs, verbose)
      # ------------------------------------
      - name: "PHPCS - final scan (fail if errors remain)"
        run: |
          phpcs ./ \
            --standard=.phpcs.xml.dist \
            --colors \
            --report=full \
            --report-file=phpcs-report-full.txt \
            --report-width=120 \
            --ignore=vendor,node_modules,build,assets,.github,tests,*.log
            || true

          echo "::notice title=PHPCS Report::Report saved to phpcs-report-full.txt"
          cat phpcs-report-full.txt

          ERROR_COUNT=$(grep -c "^.*ERROR.*$" phpcs-report-full.txt || echo "0")
          
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "::error title=PHPCS Errors::❌ $ERROR_COUNT PHPCS errors remain after PHPCBF!"
            exit 1
          fi

          echo "✅ All PHPCS errors fixed!"
