name: WPCS Lint + Autofix

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  lint-fix-lint:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    # Skip auto-commits.
    if: "!contains(github.event.head_commit.message, 'PHPCBF auto-fixes')"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      # Cache *only* Composer cache dir (not vendor).
      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}

      - name: Install stable deps (no dev)
        run: |
          composer install --no-interaction --no-dev --prefer-dist --no-progress

      # Install PHPCS globally (no vendor changes!).
      - name: Install PHPCS globally
        run: |
          composer global require \
            "squizlabs/php_codesniffer:^3.10" \
            "wp-coding-standards/wpcs:^3.1" \
            "woocommerce/woocommerce-sniffs" \
            --no-interaction --prefer-dist

      # Copy global phpcs to project (read-only).
      - name: Setup PHPCS
        run: |
          mkdir -p ~/.local/bin
          ln -sf ~/.composer/vendor/bin/phpcs ~/.local/bin/phpcs
          ln -sf ~/.composer/vendor/bin/phpcbf ~/.local/bin/phpcbf
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      # ------------------------------------
      # 1️⃣ Initial scan
      # ------------------------------------
      - name: PHPCS – initial scan
        run: |
          phpcs ./ \
            --standard=.phpcs.xml.dist \
            --colors --report=summary \
            --ignore=vendor,node_modules,build,assets,.github,tests,*.log \
            || true

      # ------------------------------------
      # 2️⃣ Autofix
      # ------------------------------------
      - name: PHPCBF – autofix
        run: |
          phpcbf ./ \
            --standard=.phpcs.xml.dist \
            --no-patch \
            --ignore=vendor,node_modules,build,assets,.github,tests,*.log \
            || true

      # ------------------------------------
      # 3️⃣ Commit (only main pushes)
      # ------------------------------------
      - name: Commit auto-fixes
        if: github.ref == 'refs/heads/main'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: PHPCBF auto-fixes [skip ci]"
          file_pattern: "**/*.php"
          exclude: |
            vendor/**
            node_modules/**
            .github/**
            *.lock
            composer.*
            *.md
          push_options: "--force"
          skip_fetch: false

      # ------------------------------------
      # 4️⃣ Final lint (PRs only)
      # ------------------------------------
      - name: PHPCS – final scan
        if: github.event_name == 'pull_request'
        run: |
          phpcs ./ \
            --standard=.phpcs.xml.dist \
            --colors --report=summary \
            --ignore=vendor,node_modules,build,assets,.github,tests,*.log \
            || exit 1
